{"version":3,"sources":["../../src/bootstrap/index.js"],"names":["Promise","require","_","slash","fs","md5File","crypto","del","path","apiRunnerNode","graphql","store","emitter","loadPlugins","initCache","report","getConfigFile","process","on","reason","p","panic","extractQueries","runQueries","writePages","writeRedirects","preferDefault","m","default","module","exports","args","program","directory","dispatch","type","payload","activity","activityTimer","start","end","config","flattenedPlugins","pluginVersions","map","version","all","resolve","catch","hashes","pluginsHash","createHash","update","JSON","stringify","concat","digest","state","getState","oldPluginsHash","status","PLUGINS_HASH","info","stripIndent","remove","error","ensureDirSync","srcDir","__dirname","siteDir","tryRequire","copy","clobber","emptyDir","hasAPIFile","env","plugin","skipSSR","undefined","envAPIs","Array","isArray","length","join","ssrPlugins","filter","options","pluginOptions","browserPlugins","browserAPIRunner","readFileSync","err","browserPluginsRequires","sSRAPIRunner","ssrPluginsRequires","writeFileSync","extensions","traceId","apiResults","flattenDeep","graphqlRunner","query","context","schema","waitForCascadingActions","printConflicts","NODE_ENV","checkJobsDone","debounce","jobs","active","log","uptime","then"],"mappings":"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","file":"index.js","sourcesContent":["/* @flow */\nconst Promise = require(`bluebird`)\n\nconst _ = require(`lodash`)\nconst slash = require(`slash`)\nconst fs = require(`fs-extra`)\nconst md5File = require(`md5-file/promise`)\nconst crypto = require(`crypto`)\nconst del = require(`del`)\nconst path = require(`path`)\n\nconst apiRunnerNode = require(`../utils/api-runner-node`)\nconst { graphql } = require(`graphql`)\nconst { store, emitter } = require(`../redux`)\nconst loadPlugins = require(`./load-plugins`)\nconst { initCache } = require(`../utils/cache`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst getConfigFile = require(`./get-config-file`)\n\n// Show stack trace on unhandled promises.\nprocess.on(`unhandledRejection`, (reason, p) => {\n  report.panic(reason)\n})\n\nconst {\n  extractQueries,\n} = require(`../internal-plugins/query-runner/query-watcher`)\nconst {\n  runQueries,\n} = require(`../internal-plugins/query-runner/page-query-runner`)\nconst { writePages } = require(`../internal-plugins/query-runner/pages-writer`)\nconst {\n  writeRedirects,\n} = require(`../internal-plugins/query-runner/redirects-writer`)\n\n// Override console.log to add the source file + line number.\n// Useful for debugging if you lose a console.log somewhere.\n// Otherwise leave commented out.\n// require(`./log-line-function`)\n\nconst preferDefault = m => (m && m.default) || m\n\ntype BootstrapArgs = {\n  directory: string,\n  prefixPaths?: boolean,\n}\n\nmodule.exports = async (args: BootstrapArgs) => {\n  const program = {\n    ...args,\n    // Fix program directory path for windows env.\n    directory: slash(args.directory),\n  }\n\n  store.dispatch({\n    type: `SET_PROGRAM`,\n    payload: program,\n  })\n\n  // Delete html and css files from the public directory as we don't want\n  // deleted pages and styles from previous builds to stick around.\n  let activity = report.activityTimer(\n    `delete html and css files from previous builds`\n  )\n  activity.start()\n  await del([\n    `public/*.{html,css}`,\n    `public/**/*.{html,css}`,\n    `!public/static`,\n    `!public/static/**/*.{html,css}`,\n  ])\n  activity.end()\n\n  // Try opening the site's gatsby-config.js file.\n  activity = report.activityTimer(`open and validate gatsby-config`)\n  activity.start()\n  const config = await preferDefault(\n    getConfigFile(program.directory, `gatsby-config`)\n  )\n\n  store.dispatch({\n    type: `SET_SITE_CONFIG`,\n    payload: config,\n  })\n\n  activity.end()\n\n  const flattenedPlugins = await loadPlugins(config)\n\n  // Check if any plugins have been updated since our last run. If so\n  // we delete the cache is there's likely been changes\n  // since the previous run.\n  //\n  // We do this by creating a hash of all the version numbers of installed\n  // plugins, the site's package.json, gatsby-config.js, and gatsby-node.js.\n  // The last, gatsby-node.js, is important as many gatsby sites put important\n  // logic in there e.g. generating slugs for custom pages.\n  const pluginVersions = flattenedPlugins.map(p => p.version)\n  const hashes = await Promise.all([\n    md5File(`package.json`),\n    Promise.resolve(\n      md5File(`${program.directory}/gatsby-config.js`).catch(() => {})\n    ), // ignore as this file isn't required),\n    Promise.resolve(\n      md5File(`${program.directory}/gatsby-node.js`).catch(() => {})\n    ), // ignore as this file isn't required),\n  ])\n  const pluginsHash = crypto\n    .createHash(`md5`)\n    .update(JSON.stringify(pluginVersions.concat(hashes)))\n    .digest(`hex`)\n  let state = store.getState()\n  const oldPluginsHash = state && state.status ? state.status.PLUGINS_HASH : ``\n\n  // Check if anything has changed. If it has, delete the site's .cache\n  // directory and tell reducers to empty themselves.\n  //\n  // Also if the hash isn't there, then delete things just in case something\n  // is weird.\n  if (oldPluginsHash && pluginsHash !== oldPluginsHash) {\n    report.info(report.stripIndent`\n      One or more of your plugins have changed since the last time you ran Gatsby. As\n      a precaution, we're deleting your site's cache to ensure there's not any stale\n      data\n    `)\n  }\n\n  if (!oldPluginsHash || pluginsHash !== oldPluginsHash) {\n    try {\n      await fs.remove(`${program.directory}/.cache`)\n    } catch (e) {\n      report.error(`Failed to remove .cache files.`, e)\n    }\n    // Tell reducers to delete their data (the store will already have\n    // been loaded from the file system cache).\n    store.dispatch({\n      type: `DELETE_CACHE`,\n    })\n  }\n\n  // Update the store with the new plugins hash.\n  store.dispatch({\n    type: `UPDATE_PLUGINS_HASH`,\n    payload: pluginsHash,\n  })\n\n  // Now that we know the .cache directory is safe, initialize the cache\n  // directory.\n  initCache()\n\n  // Ensure the public/static directory is created.\n  await fs.ensureDirSync(`${program.directory}/public/static`)\n\n  // Copy our site files to the root of the site.\n  activity = report.activityTimer(`copy gatsby files`)\n  activity.start()\n  const srcDir = `${__dirname}/../../cache-dir`\n  const siteDir = `${program.directory}/.cache`\n  const tryRequire = `${__dirname}/../utils/test-require-error.js`\n  try {\n    await fs.copy(srcDir, siteDir, { clobber: true })\n    await fs.copy(tryRequire, `${siteDir}/test-require-error.js`, {\n      clobber: true,\n    })\n    await fs.ensureDirSync(`${program.directory}/.cache/json`)\n    await fs.ensureDirSync(`${program.directory}/.cache/layouts`)\n\n    // Ensure .cache/fragments exists and is empty. We want fragments to be\n    // added on every run in response to data as fragments can only be added if\n    // the data used to create the schema they're dependent on is available.\n    await fs.emptyDir(`${program.directory}/.cache/fragments`)\n  } catch (err) {\n    report.panic(`Unable to copy site files to .cache`, err)\n  }\n\n  // Find plugins which implement gatsby-browser and gatsby-ssr and write\n  // out api-runners for them.\n  const hasAPIFile = (env, plugin) => {\n    // The plugin loader has disabled SSR APIs for this plugin. Usually due to\n    // multiple implementations of an API that can only be implemented once\n    if (env === `ssr` && plugin.skipSSR === true) return undefined\n\n    const envAPIs = plugin[`${env}APIs`]\n    if (envAPIs && Array.isArray(envAPIs) && envAPIs.length > 0) {\n      return slash(path.join(plugin.resolve, `gatsby-${env}`))\n    }\n    return undefined\n  }\n\n  const ssrPlugins = _.filter(\n    flattenedPlugins.map(plugin => {\n      return {\n        resolve: hasAPIFile(`ssr`, plugin),\n        options: plugin.pluginOptions,\n      }\n    }),\n    plugin => plugin.resolve\n  )\n  const browserPlugins = _.filter(\n    flattenedPlugins.map(plugin => {\n      return {\n        resolve: hasAPIFile(`browser`, plugin),\n        options: plugin.pluginOptions,\n      }\n    }),\n    plugin => plugin.resolve\n  )\n\n  let browserAPIRunner = ``\n\n  try {\n    browserAPIRunner = fs.readFileSync(\n      `${siteDir}/api-runner-browser.js`,\n      `utf-8`\n    )\n  } catch (err) {\n    report.panic(`Failed to read ${siteDir}/api-runner-browser.js`, err)\n  }\n\n  const browserPluginsRequires = browserPlugins\n    .map(\n      plugin =>\n        `{\n      plugin: require('${plugin.resolve}'),\n      options: ${JSON.stringify(plugin.options)},\n    }`\n    )\n    .join(`,`)\n\n  browserAPIRunner = `var plugins = [${browserPluginsRequires}]\\n${browserAPIRunner}`\n\n  let sSRAPIRunner = ``\n\n  try {\n    sSRAPIRunner = fs.readFileSync(`${siteDir}/api-runner-ssr.js`, `utf-8`)\n  } catch (err) {\n    report.panic(`Failed to read ${siteDir}/api-runner-ssr.js`, err)\n  }\n\n  const ssrPluginsRequires = ssrPlugins\n    .map(\n      plugin =>\n        `{\n      plugin: require('${plugin.resolve}'),\n      options: ${JSON.stringify(plugin.options)},\n    }`\n    )\n    .join(`,`)\n  sSRAPIRunner = `var plugins = [${ssrPluginsRequires}]\\n${sSRAPIRunner}`\n\n  fs.writeFileSync(\n    `${siteDir}/api-runner-browser.js`,\n    browserAPIRunner,\n    `utf-8`\n  )\n  fs.writeFileSync(`${siteDir}/api-runner-ssr.js`, sSRAPIRunner, `utf-8`)\n\n  activity.end()\n  /**\n   * Start the main bootstrap processes.\n   */\n\n  // onPreBootstrap\n  activity = report.activityTimer(`onPreBootstrap`)\n  activity.start()\n  await apiRunnerNode(`onPreBootstrap`)\n  activity.end()\n\n  // Source nodes\n  activity = report.activityTimer(`source and transform nodes`)\n  activity.start()\n  await require(`../utils/source-nodes`)()\n  activity.end()\n\n  // Create Schema.\n  activity = report.activityTimer(`building schema`)\n  activity.start()\n  await require(`../schema`)()\n  activity.end()\n\n  // Collect resolvable extensions and attach to program.\n  const extensions = [`.js`, `.jsx`]\n  // Change to this being an action and plugins implement `onPreBootstrap`\n  // for adding extensions.\n  const apiResults = await apiRunnerNode(`resolvableExtensions`, {\n    traceId: `initial-resolvableExtensions`,\n  })\n\n  store.dispatch({\n    type: `SET_PROGRAM_EXTENSIONS`,\n    payload: _.flattenDeep([extensions, apiResults]),\n  })\n\n  const graphqlRunner = (query, context = {}) => {\n    const schema = store.getState().schema\n    return graphql(schema, query, context, context, context)\n  }\n\n  // Collect layouts.\n  activity = report.activityTimer(`createLayouts`)\n  activity.start()\n  await apiRunnerNode(`createLayouts`, {\n    graphql: graphqlRunner,\n    traceId: `initial-createLayouts`,\n    waitForCascadingActions: true,\n  })\n  activity.end()\n\n  // Collect pages.\n  activity = report.activityTimer(`createPages`)\n  activity.start()\n  await apiRunnerNode(`createPages`, {\n    graphql: graphqlRunner,\n    traceId: `initial-createPages`,\n    waitForCascadingActions: true,\n  })\n  activity.end()\n\n  // A variant on createPages for plugins that want to\n  // have full control over adding/removing pages. The normal\n  // \"createPages\" API is called every time (during development)\n  // that data changes.\n  activity = report.activityTimer(`createPagesStatefully`)\n  activity.start()\n  await apiRunnerNode(`createPagesStatefully`, {\n    graphql: graphqlRunner,\n    traceId: `initial-createPagesStatefully`,\n    waitForCascadingActions: true,\n  })\n  activity.end()\n\n  activity = report.activityTimer(`onPreExtractQueries`)\n  activity.start()\n  await apiRunnerNode(`onPreExtractQueries`)\n  activity.end()\n\n  // Update Schema for SitePage.\n  activity = report.activityTimer(`update schema`)\n  activity.start()\n  await require(`../schema`)()\n  activity.end()\n\n  require(`../schema/type-conflict-reporter`).printConflicts()\n\n  // Extract queries\n  activity = report.activityTimer(`extract queries from components`)\n  activity.start()\n  await extractQueries()\n  activity.end()\n\n  // Start the createPages hot reloader.\n  if (process.env.NODE_ENV !== `production`) {\n    require(`./page-hot-reloader`)(graphqlRunner)\n  }\n\n  // Run queries\n  activity = report.activityTimer(`run graphql queries`)\n  activity.start()\n  await runQueries()\n  activity.end()\n\n  // Write out files.\n  activity = report.activityTimer(`write out page data`)\n  activity.start()\n  try {\n    await writePages()\n  } catch (err) {\n    report.panic(`Failed to write out page data`, err)\n  }\n  activity.end()\n\n  // Write out redirects.\n  activity = report.activityTimer(`write out redirect data`)\n  activity.start()\n  await writeRedirects()\n  activity.end()\n\n  const checkJobsDone = _.debounce(resolve => {\n    const state = store.getState()\n    if (state.jobs.active.length === 0) {\n      report.log(``)\n      report.info(`bootstrap finished - ${process.uptime()} s`)\n      report.log(``)\n\n      // onPostBootstrap\n      activity = report.activityTimer(`onPostBootstrap`)\n      activity.start()\n      apiRunnerNode(`onPostBootstrap`).then(() => {\n        activity.end()\n        resolve({ graphqlRunner })\n      })\n    }\n  }, 100)\n\n  if (store.getState().jobs.active.length === 0) {\n    // onPostBootstrap\n    activity = report.activityTimer(`onPostBootstrap`)\n    activity.start()\n    await apiRunnerNode(`onPostBootstrap`)\n    activity.end()\n\n    report.log(``)\n    report.info(`bootstrap finished - ${process.uptime()} s`)\n    report.log(``)\n    return { graphqlRunner }\n  } else {\n    return new Promise(resolve => {\n      // Wait until all side effect jobs are finished.\n      emitter.on(`END_JOB`, () => checkJobsDone(resolve))\n    })\n  }\n}\n"]}